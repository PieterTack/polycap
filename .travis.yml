language: generic

env:
  global:
    - CXXFLAGS="-Wall -Werror"
    - CFLAGS="-Wall -Werror"
    - LD_LIBRARY_PATH='/usr/local/lib'
    - PKG_CONFIG_PATH='/usr/local/lib/pkgconfig'

matrix:
  include:
    - os: linux
      sudo: required
      dist: trusty
      addons:
        apt:
          sources:
            - sourceline: 'deb [arch=amd64] http://xmi-apt.tomschoonjans.eu/ubuntu trusty stable'
              key_url: 'http://xmi-apt.tomschoonjans.eu/xmi.packages.key'
            - ubuntu-toolchain-r-test
          packages:
            - libgsl0-dev
            - libxrl7-dev
            - libhdf5-serial-dev
            - hdf5-tools
            - gcc-8
            - python-all-dev
            - python-numpy
            - python3-all-dev
            - python3-numpy
      env: CC='gcc-8' XRL_PYTHON2='/usr/bin/python' XRL_PYTHON3='/usr/bin/python3'
    - os: linux
      sudo: required
      dist: trusty
      addons:
        apt:
          sources:
            - sourceline: 'deb [arch=amd64] http://xmi-apt.tomschoonjans.eu/ubuntu trusty stable'
              key_url: 'http://xmi-apt.tomschoonjans.eu/xmi.packages.key'
            - ubuntu-toolchain-r-test
          packages:
            - libgsl0-dev
            - libeasyrng-dev
            - libxrl7-dev
            - libhdf5-serial-dev
            - hdf5-tools
            - gcc-8
            - python-all-dev
            - python-numpy
            - python3-all-dev
            - python3-numpy
      env: CC='gcc-8' XRL_PYTHON2='/usr/bin/python' XRL_PYTHON3='/usr/bin/python3'
    - os: osx
      osx_image: xcode9.2
      sudo: required
      env: CC='/usr/local/opt/llvm/bin/clang' HOMEBREW_ARGS='llvm' EXTRA_LIBS='-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib' XRL_PYTHON2='/usr/local/opt/python@2/bin/python2' XRL_PYTHON3='/usr/local/bin/python3'
    - os: osx
      osx_image: xcode9.2
      sudo: required
      env: CC='/usr/local/bin/gcc-8' HOMEBREW_ARGS='gcc@8' XRL_PYTHON2='/usr/local/opt/python@2/bin/python2' XRL_PYTHON3='/usr/local/bin/python3'
    - os: osx
      osx_image: xcode9.2
      sudo: required
      env: CC='/usr/local/opt/llvm/bin/clang' CXX='/usr/local/opt/llvm/bin/clang++' HOMEBREW_ARGS='llvm tschoonj/tap/easyrng' EXTRA_LIBS='-L/usr/local/opt/llvm/lib -Wl,-rpath,/usr/local/opt/llvm/lib' XRL_PYTHON2='/usr/local/opt/python@2/bin/python2' XRL_PYTHON3='/usr/local/bin/python3'
    - os: osx
      osx_image: xcode9.2
      sudo: required
      env: CC='/usr/local/bin/gcc-8' CXX='/usr/local/bin/g++-8' HOMEBREW_ARGS='gcc@8 tschoonj/tap/easyrng' XRL_PYTHON2='/usr/local/opt/python@2/bin/python2' XRL_PYTHON3='/usr/local/bin/python3'

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ] ; then
      rm -rf $(brew --prefix)/lib/python*
      rm -rf $(brew --prefix)/bin/f2py*
      brew cask uninstall --force oclint
      brew uninstall --force --ignore-dependencies $(brew list) || exit 1
      brew update || exit 1
      brew cleanup -s || exit 1
      rm -rf $(brew --cache) || exit 1
      brew install hdf5 git autoconf automake libtool curl wget pkg-config gsl python python@2 numpy || exit 1
      brew install $HOMEBREW_ARGS tschoonj/tap/xraylib || exit 1
      brew cleanup -s || exit 1
      rm -rf $(brew --cache) || exit 1
      /usr/local/opt/python@2/bin/pip2.7 install numpy || exit 1
    else
      sudo pip install Cython || exit 1
      export PATH=/usr/local/bin:$PATH
    fi

script:
  - autoreconf -fi || exit 1
  - export LIBS="$LIBS $EXTRA_LIBS"
  - ./configure --disable-python || (cat config.log && exit 1)
  - make || exit 1
  - make check || exit 1
  - make distclean || exit 1
  - ./configure --enable-python PYTHON=${XRL_PYTHON2} || exit 1
  - make || exit 1
  - make check || exit 1
  - make distclean || exit 1
  - ./configure --enable-python PYTHON=${XRL_PYTHON3} || exit 1
  - make || exit 1
  - make check || exit 1
  - PYTHON=${XRL_PYTHON2} make distcheck || exit 1

notifications:
  email:
    recipients:
      - Tom.Schoonjans@me.com
      - Pieter.Tack@UGent.be
    on_success: never
    on_failure: always

branches:
  only:
    - master

